---
kind: pipeline
name: matrix-1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: owncloud-coding-standard
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make test-php-style

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make vendor
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ a:e testing
  - php occ a:l
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpstan
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phpstan
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: build
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make dist

- name: github_release
  pull: always
  image: plugins/github-release
  settings:
    checksum: sha256
    file_exists: overwrite
    files: build/dist/testing.tar.gz
    prerelease: true
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  when:
    event:
    - tag

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-4

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phan
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phan
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-5

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-6

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: pgsql
    db_name: owncloud
    db_password: owncloud
    db_type: pgsql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: pgsql
  pull: if-not-exists
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: autotest

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-7

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: oci
    db_name: XE
    db_password: owncloud
    db_type: oci
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: oci
  pull: if-not-exists
  image: deepdiver/docker-oracle-xe-11g
  environment:
    ORACLE_DB: XE
    ORACLE_PASSWORD: oracle
    ORACLE_USER: system

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-8

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phan
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-phan
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-9

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phan
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-phan
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-10

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: phan
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make test-php-phan
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.0
  commands:
  - if [ "false" = "false" ]; then make test-php-unit; fi
  - if [ "false" = "true" ]; then make test-php-unit-dbg; fi
  environment:
    COVERAGE: false

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ a:e testing
  - php occ a:l
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "false" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "false" = "true" ]; then cd /var/www/owncloud/testrunner/apps/testing; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTestingApp
    PLATFORM: Linux
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-12

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make vendor
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ a:e testing
  - php occ a:l
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.2
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "false" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - if [ "false" = "true" ]; then cd /var/www/owncloud/testrunner/apps/testing; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTestingApp
    PLATFORM: Linux
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.2
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-13

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: daily-master-qa

- name: install-app
  pull: always
  image: owncloudci/php:7.0
  commands:
  - make vendor
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ a:e testing
  - php occ a:l
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.0
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "false" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.0
  commands:
  - if [ "false" = "true" ]; then cd /var/www/owncloud/testrunner/apps/testing; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTestingApp
    PLATFORM: Linux
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.0
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

---
kind: pipeline
name: matrix-14

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: apps/testing

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: autotest
    exclude:
    - apps/testing
    version: 10.2.1

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /var/www/owncloud/testrunner
  - cp -r /var/www/owncloud/apps/testing /var/www/owncloud/testrunner/apps/
  - cd /var/www/owncloud/testrunner
  - make install-composer-deps
  - make vendor-bin-deps

- name: install-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor
  - cd /var/www/owncloud/
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ a:e testing
  - php occ a:l
  environment:
    COMPOSER_HOME: /var/www/owncloud/apps/testing/.cache/composer

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /var/www/owncloud -R
  - if [ "true" = "true" ]; then chmod 777 /var/www/owncloud/testrunner/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/testrunner/tests/acceptance/run.sh; else chmod 777 /var/www/owncloud/tests/acceptance/filesForUpload -R; chmod +x /var/www/owncloud/tests/acceptance/run.sh; fi

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - if [ "true" = "true" ]; then cd /var/www/owncloud/testrunner/apps/testing; fi
  - make test-acceptance-api
  environment:
    BEHAT_SUITE: apiTestingApp
    PLATFORM: Linux
    TEST_SERVER_URL: http://owncloud

- name: notify
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
  environment:
    SLACK_WEBHOOK:
      from_secret: slack_webhook
  when:
    event:
    - push
    - tag
    status:
    - failure
    - changed

services:
- name: mysql
  pull: if-not-exists
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: autotest

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master

...
