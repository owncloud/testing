workspace:
  base: /var/www/owncloud
  path: apps/testing

branches:
  - master

pipeline:
  install-server:
    image: owncloudci/core
    pull: true
    exclude:
    - apps/testing
    version: daily-stable10-qa

  install-app:
    image: owncloudci/php
    pull: true
    environment:
    - COMPOSER_HOME=/var/www/owncloud/apps/testing/.cache/composer
    commands:
    - make vendor
    - cd /var/www/owncloud/
    - php occ a:l
    - php occ a:e testing
    - php occ a:l

  prepare-lint:
    image: owncloudci/php
    pull: true
    commands:
      - make vendor-bin/php-parallel-lint/vendor

  lint-php5:
    image: owncloudci/php:5.6
    pull: true
    group: lint
    commands:
      - make test-php-lint

  lint-php70:
    image: owncloudci/php:7.0
    pull: true
    group: lint
    commands:
      - make test-php-lint

  lint-php71:
    image: owncloudci/php:7.1
    pull: true
    group: lint
    commands:
      - make test-php-lint

  lint-php72:
    image: owncloudci/php:7.2
    pull: true
    group: lint
    commands:
      - make test-php-lint

  owncloud-coding-standard:
    image: owncloudci/php:7.1
    pull: true
    commands:
      - make test-php-style

  phpunit-unit-tests:
    image: owncloudci/php
    pull: true
    commands:
    - make test-php-unit-dbg

  build:
    image: owncloudci/php:7.1
    pull: true
    commands:
      - make dist

  github_release:
    image: plugins/github-release
    pull: true
    secrets: [ github_token ]
    files: build/dist/testing.tar.gz
    prerelease: true
    file_exists: overwrite
    checksum: sha256
    when:
      event: tag